{% extends "base.html" %}  
{% block content %} 
<!-- 
<!DOCTYPE html>
<meta charset="utf-8">
 -->
<head><title>{{title}}</title></head>
<style>

.node {
  cursor: pointer;
  fill: {{fillColor}};
//  fill-opacity: .25;
  stroke: #d8d8d8;
  stroke-width: 1px;
}

.node:hover {
  stroke: #000;
  stroke-width: 1.5px;
}

.node--root {
  stroke: #777;
  stroke-width: 2px;
  fill: {{fillColor}};
  fill-opacity:{{opacityRoot}};
}

.node--leaf-neutral {
  fill:{{nColor}};
  fill-opacity:1
}

.node--leaf-{{subA}} {
  fill:{{colorA}};
  fill-opacity: 1;
}

.node--leaf-{{subB}} {
  fill:{{colorB}};
  fill-opacity: 1;
}

.label {
  font: {{fSize}}px {{fontType}};
  text-anchor: middle;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
}

.label,
.node--root,
.node--leaf {
  pointer-events: none;
  
}
/* /Download button */
.download { 
  background: #333; 
  color: #FFF; 
  font-weight: 900; 
  border: 2px solid #B10000; 
  padding: 4px; 
  margin:4px;
}
</style>
<body>
<h2 style='text-align: center;'>{{title}}</h2>

<button type="button" class="download" onclick="download()">Download</button>
<script src="http://d3js.org/d3.v3.min.js"></script>

<script>

var margin = 10,
    outerDiameter = 1280,//960,
    innerDiameter = outerDiameter - margin - margin;

var x = d3.scale.linear()
    .range([0, innerDiameter]);

var y = d3.scale.linear()
    .range([0, innerDiameter]);

var color = d3.scale.linear()
    .domain([-1, 5])
    .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
    .interpolate(d3.interpolateHcl);
    
var pack = d3.layout.pack()
    .padding(2)
    .size([innerDiameter, innerDiameter])
    .value(function(d) { 
               d.type = '{{subB}}';
               if (Math.round(Math.abs(d.size)) <  {{fc_limit}})
                   d.type = 'neutral';
               else if (d.size < -{{fc_limit}})
                   d.type = '{{subA}}';
               return Math.abs(d.size); 
           });    

var svg = d3.select("body").append("svg:svg")
    .attr("width", outerDiameter)
    .attr("height", outerDiameter)
  .append("g")
    .attr("transform", "translate(" + margin + "," + margin + ")");

d3.json("{{reqFile}}", function(error, root) {
  var focus = root,
      nodes = pack.nodes(root);

  svg.append("g").selectAll("circle")
      .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) {
                         if (!d.parent)
                            return "node node--root"
                         if (d.children) 
                             return "node";
                         if (d.type === '{{subA}}')
                             return "node node--leaf-{{subA}}";
                         if (d.type === '{{subB}}')
                             return "node node--leaf-{{subB}}";
                         if (d.type === 'neutral')
                             return "node node--leaf-neutral"; 
                     })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .attr("r", function(d) { return d.r; })
      .on("click", function(d) { return zoom(focus == d ? root : d); });

  svg.append("g").selectAll("text")
      .data(nodes)
    .enter().append("text")
      .attr("class", "label")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
      .style("display", function(d) { return d.parent === root ? null : "none"; })
      .text(function(d) { return d.name + (d.children ? "" : ": " + Number((Math.abs(d.size)).toFixed(1))); });

  d3.select(window)
      .on("click", function() { zoom(root); });

  function zoom(d, i) {
    var focus0 = focus;
    focus = d;

    var k = innerDiameter / d.r / 2;
    x.domain([d.x - d.r, d.x + d.r]);
    y.domain([d.y - d.r, d.y + d.r]);
    d3.event.stopPropagation();

    var transition = d3.selectAll("text,circle").transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

    transition.filter("circle")
        .attr("r", function(d) { return k * d.r; });

    transition.filter("text")
      .filter(function(d) { return d.parent === focus || d.parent === focus0; })
        .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
        .each("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
        .each("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
  }
});

d3.select(self.frameElement).style("height", outerDiameter + "px");


function download(){
  var e = document.createElement('script');
  if (window.location.protocol === 'https:'){
    e.setAttribute('src', 'https://rawgit.com/NYTimes/svg-crowbar/gh-pages/svg-crowbar.js');
  }
  else{
    e.setAttribute('src', 'http://nytimes.github.com/svg-crowbar/svg-crowbar.js'); 
  }
  e.setAttribute('class', 'svg-crowbar');
  document.body.appendChild(e); 
}
//trying to add downloading as svg capabilities
// d3.select("#download")
//     .on("mouseover", writeDownloadLink);

// function writeDownloadLink(){
//     var html = d3.select("svg")
//         .attr("title", "test2")
//         .attr("version", 1.1)
//         .attr("xmlns", "http://www.w3.org/2000/svg")
//         .node().parentNode.innerHTML;

//     d3.select("body").append("div")
//         .attr("id", "download")
//         .style("top", event.clientY+20+"px")
//         .style("left", event.clientX+"px")
//         .html("Right-click on this preview and choose Save as<br />Left-Click to dismiss<br />")
//         .append("img")
//         .attr("src", "data:image/svg+xml;base64,"+ btoa(html));

//     d3.select("#download")
//         .on("click", function(){
//             if(event.button == 0){
//                 d3.select(this).transition()
//                     .style("opacity", 0)
//                     .remove();
//             }
//         })
//         .transition()
//         .duration(500)
//         .style("opacity", 1);
// };

</script>

{% endblock %}